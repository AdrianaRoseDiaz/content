{
  "LateralMovementEvidence": {
    "network_connections": "DeviceNetworkEvents\n| where (RemoteIP startswith \"172.16\" or RemoteIP startswith \"192.168\" or RemoteIP startswith \"10.\") and ( (InitiatingProcessSHA1 has_any (\"1\",\"2\")) )\n| summarize TotalConnections = count() by DeviceName, RemoteIP, RemotePort, InitiatingProcessFileName\n| order by TotalConnections\n| limit 1",
    "credential_dumping": "DeviceProcessEvents\n| where ((FileName has_any (\"procdump.exe\", \"procdump64.exe\") and ProcessCommandLine has \"lsass\") or (ProcessCommandLine has \"lsass.exe\" and (ProcessCommandLine has \"-accepteula\" or ProcessCommandLine contains \"-ma\")) ) and ( (DeviceName has_any (\"1\")) )\n| project Timestamp, DeviceName, ActionType, FileName, ProcessCommandLine, AccountName, InitiatingProcessIntegrityLevel, InitiatingProcessTokenElevation\n| limit 10",
    "network_enumeration": "DeviceNetworkEvents\n| where RemotePort == 445 and InitiatingProcessId !in (0, 4) and ( (DeviceName has_any (\"1\")) )\n| summarize RemoteIPCount=dcount(RemoteIP) by DeviceName, InitiatingProcessFileName, InitiatingProcessId, InitiatingProcessCreationTime\n| where RemoteIPCount > 1\n| limit 10",
    "rdp_attempts": "DeviceNetworkEvents\n| where RemotePort in (22,3389,139,135,23,1433) and ( (DeviceName has_any (\"1\")) )\n| summarize TotalCount=count() by DeviceName,LocalIP,RemoteIP,RemotePort\n| order by TotalCount\n| limit 10",
    "smb_connections": "DeviceNetworkEvents\n| where RemotePort == 445 and InitiatingProcessId !in (0, 4) and ( (InitiatingProcessMD5 has_any (\"1\",\"2\")) )\n| summarize RemoteIPCount=dcount(RemoteIP) by DeviceName, InitiatingProcessFileName, InitiatingProcessId, InitiatingProcessCreationTime\n| limit 1"
  },
  "PersistenceEvidence": {
    "scheduled_job": "DeviceEvents | where ActionType == \"ScheduledTaskCreated\" and InitiatingProcessAccountSid != \"S-1-5-18\" and ( (SHA1 has_any (\"1\",\"2\")) )\n| project Timestamp, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, AdditionalFields\n| limit 1",
    "registry_entry": "DeviceRegistryEvents | where ActionType == \"RegistryValueSet\" and ( (InitiatingProcessSHA1 has_any (\"1\",\"2\")) and InitiatingProcessCommandLine contains \"something\" )\n| project Timestamp, DeviceName, RegistryKey, RegistryValueType, PreviousRegistryValueData, RegistryValueName, PreviousRegistryValueData, PreviousRegistryValueName, PreviousRegistryKey, InitiatingProcessFileName\n| limit 1",
    "startup_folder_changes": "DeviceFileEvents | where FolderPath contains @\"\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\" and ActionType == \"FileCreated\" and ( (SHA1 has_any (\"1\",\"2\")) )\n| project Timestamp, DeviceName, FileName, FolderPath, InitiatingProcessFileName, InitiatingProcessVersionInfoProductName, InitiatingProcessVersionInfoOriginalFileName, InitiatingProcessCommandLine InitiatingProcessFileName\n| limit 1",
    "new_service_created": "DeviceRegistryEvents | where RegistryKey contains @\"HKEY_LOCAL_MACHINE\\SYSTEM\\ControlSet001\\Services\" and ActionType == \"RegistryKeyCreated\" and ( (InitiatingProcessSHA1 has_any (\"1\",\"2\")) )\n| project Timestamp, DeviceName, ActionType, RegistryKey, RegistryValueName, RegistryValueType, RegistryValueData, InitiatingProcessFileName, InitiatingProcessVersionInfoProductName, InitiatingProcessVersionInfoOriginalFileName, InitiatingProcessCommandLine\n| limit 1",
    "service_updated": "DeviceRegistryEvents | where RegistryKey contains @\"HKEY_LOCAL_MACHINE\\SYSTEM\\ControlSet001\\Services\" and ActionType has_any (\"RegistryValueSet\",\"RegistryKeyCreated\") and ( (InitiatingProcessSHA1 has_any (\"1\",\"2\")) )\n| project Timestamp, DeviceName, ActionType, RegistryKey, PreviousRegistryKey, RegistryValueName, PreviousRegistryValueName, RegistryValueType, RegistryValueData, PreviousRegistryValueData, InitiatingProcessFileName, InitiatingProcessVersionInfoProductName, InitiatingProcessVersionInfoOriginalFileName, InitiatingProcessCommandLine\n| limit 1",
    "file_replaced": "DeviceFileEvents | where FolderPath contains @\"C:\\Program Files\" and ActionType == \"FileModified\" and ( (SHA1 has_any (\"1\",\"2\")) )\n| project Timestamp, DeviceName, ActionType, FileName, FolderPath, InitiatingProcessFileName, InitiatingProcessVersionInfoProductName, InitiatingProcessVersionInfoOriginalFileName, InitiatingProcessCommandLine\n| limit 1",
    "new_user": "DeviceEvents | where ActionType == \"UserAccountCreated\" and ( (SHA1 has_any (\"1\",\"2\")) )\n| project AccountName,DeviceName,Timestamp,AccountSid,AccountDomain,InitiatingProcessAccountName,InitiatingProcessLogonId\n| limit 1",
    "new_group": "DeviceEvents | where ActionType == \"SecurityGroupCreated\" and ( (SHA1 has_any (\"1\",\"2\")) )\n| project AccountName,DeviceName,Timestamp,AccountSid,AccountDomain,InitiatingProcessAccountName,InitiatingProcessLogonId\n| limit 1",
    "group_user_change": "DeviceEvents | where ActionType == \"UserAccountAddedToLocalGroup\" and ( (SHA1 has_any (\"1\",\"2\")) )\n| summarize by AccountSid\n| limit 1",
    "local_firewall_change": "DeviceRegistryEvents | where RegistryKey contains @\"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\" and ( (InitiatingProcessSHA1 has_any (\"1\",\"2\")) )\n| project Timestamp, DeviceName, ActionType, RegistryKey, PreviousRegistryKey, RegistryValueName, PreviousRegistryValueName, RegistryValueType, RegistryValueData, PreviousRegistryValueData, InitiatingProcessFileName, InitiatingProcessVersionInfoProductName, InitiatingProcessVersionInfoOriginalFileName, InitiatingProcessCommandLine\n| limit 1",
    "host_file_change": "DeviceFileEvents | where FolderPath contains @\"C:\\Windows\\System32\\drivers\\etc\\hosts\" and ActionType == \"FileModified\" and ( (InitiatingProcessSHA1 has_any (\"1\",\"2\")) )\n| project Timestamp, DeviceName, ActionType, FileName, FolderPath, SHA1, SHA256, MD5, InitiatingProcessFileName, InitiatingProcessVersionInfoProductName, InitiatingProcessVersionInfoOriginalFileName, InitiatingProcessCommandLine\n| limit 1"
  },
  "FileOrigin": "DeviceFileEvents | where ( (SHA1 has_any (\"1\",\"2\")) )\n| project Timestamp,FileName,FolderPath, ActionType,DeviceName,MD5,SHA1,SHA256,FileSize,FileOriginUrl,FileOriginIP,InitiatingProcessCommandLine,InitiatingProcessFileName,InitiatingProcessParentFileName\n| limit 1",
  "ProcessDetails": {
    "parent_process": "DeviceProcessEvents | where ( (SHA1 has_any (\"1\",\"2\")) )\n| project Timestamp, DeviceId, DeviceName, ActionType, ProcessId, ProcessCommandLine, ProcessCreationTime, AccountSid, AccountName, AccountDomain,InitiatingProcessAccountDomain, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessAccountSid, InitiatingProcessAccountSid, InitiatingProcessAccountUpn, InitiatingProcessAccountObjectId, InitiatingProcessLogonId, InitiatingProcessIntegrityLevel, InitiatingProcessTokenElevation, InitiatingProcessSHA1, InitiatingProcessSHA256, InitiatingProcessMD5, InitiatingProcessFileName, InitiatingProcessFileSize, InitiatingProcessVersionInfoCompanyName, InitiatingProcessVersionInfoProductName, InitiatingProcessVersionInfoProductVersion, InitiatingProcessVersionInfoInternalFileName, InitiatingProcessVersionInfoOriginalFileName, InitiatingProcessVersionInfoFileDescription, InitiatingProcessId, InitiatingProcessCommandLine, InitiatingProcessCreationTime, InitiatingProcessFolderPath, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessAccountSid\n| limit 1",
    "grandparent_process": "DeviceProcessEvents | where ( (SHA1 has_any (\"1\",\"2\")) )\n| project Timestamp, DeviceId, DeviceName, ActionType, ProcessId, ProcessCommandLine, ProcessIntegrityLevel, ProcessCreationTime, AccountSid, AccountName, AccountDomain, AccountObjectId, AccountUpn, InitiatingProcessSHA1, InitiatingProcessSHA256, InitiatingProcessMD5, InitiatingProcessFileName, InitiatingProcessId, InitiatingProcessCreationTime, InitiatingProcessFolderPath, InitiatingProcessParentFileName, InitiatingProcessParentId, InitiatingProcessParentCreationTime\n| limit 1",
    "process": "DeviceProcessEvents | where ( (SHA1 has_any (\"1\",\"2\")) )\n| summarize by SHA1,FileName,SHA256,MD5 | join DeviceFileCertificateInfo on SHA1 | summarize by FileName,SHA1,SHA256,IsSigned,Signer,SignatureType,Issuer,CertificateExpirationTime,IsTrusted,IsRootSignerMicrosoft\n| limit 1",
    "beaconing_evidence": "DeviceProcessEvents | where ( (InitiatingProcessSHA1 has_any (\"1\",\"2\")) )\n| project Timestamp, DeviceId, DeviceName, ActionType, RemoteIP, RemotePort, RemoteUrl, LocalIP, LocalPort, Protocol, LocalIPType, RemoteIPType, InitiatingProcessSHA1, InitiatingProcessSHA256, InitiatingProcessMD5, InitiatingProcessFileName\n| limit 1"
  }
}
