"""Base Script for Cortex XSOAR (aka Demisto)

This is an empty script with some basic structure according
to the code conventions.

MAKE SURE YOU REVIEW/REPLACE ALL THE COMMENTS MARKED AS "TODO"

Developer Documentation: https://xsoar.pan.dev/docs/welcome
Code Conventions: https://xsoar.pan.dev/docs/integrations/code-conventions
Linting: https://xsoar.pan.dev/docs/integrations/linting

"""

import demistomock as demisto
from CommonServerPython import *
from CommonServerUserPython import *

from typing import Dict, Any
import traceback

''' STANDALONE FUNCTION '''

INCIDENT_ID = demisto.incident().get('id')

XDR_ACTIONS = {
    'allow': 'xdr-blacklist-files',
    'block': 'xdr-whitelist-files'
}

MSDE_ACTIONS = {
    'allow': 'Allow',
    'block': 'AlertAndBlock',
}

CROWDSTRIKE_ACTIONS = {
    'allow': {'action': 'allow',
              'description': f'Whitelisted based on XSOAR inc {INCIDENT_ID}',
              'severity': 'low'},
    'block': {'action': 'prevent',
              'description': f'Blacklisted based on XSOAR inc {INCIDENT_ID}',
              'severity': 'high'}
}


def execute_command(command, args, extract_contents=True):
    execute_command_results = demisto.executeCommand(command, args)
    results, errors = [], []
    for res in execute_command_results:
        if is_error(res):
            error_message = f'{res.get("ModuleName")}: {get_error(res)}'
            errors.append(error_message)
        else:
            if not extract_contents:
                results.append(res)
            else:
                content = res.get('Contents', {})
                if content:
                    results.append(content)
    return results, errors


def run_xdr_action(hashes: List[str], action: str):
    command = XDR_ACTIONS.get(action)
    xdr_results, xdr_errors = execute_command(command,
                                              {'hash_list': ','.join(hashes)},
                                              extract_contents=False)
    return xdr_results, xdr_errors


def run_msde_action(hashes: List[str], action: str):
    action = MSDE_ACTIONS.get(action)
    msde_results, msde_errors = [], []
    for h in hashes:
        results, errors = execute_command('microsoft-atp-sc-indicator-create',
                                          {'indicator_value': h,
                                           'indicator_type': 'FileSha256',
                                           'action': action,
                                           'indicator_description': f'XSOAR - related incident {INCIDENT_ID}',
                                           'indicator_title': f'XSOAR - related incident {INCIDENT_ID}'},
                                          extract_contents=False)
        msde_results.extend(results)
        msde_errors.extend(errors)
    return msde_results, msde_errors


def run_crowdstrike_falcon_action(hashes: List[str], action):
    falcon_results, falcon_errors = [], []
    ioc_metadata = CROWDSTRIKE_ACTIONS.get(action)
    search_results, errors_search = execute_command('cs-falcon-search-custom-iocs',
                                                    {'values': ','.join(hashes)},
                                                    extract_contents=True
                                                    )
    falcon_errors.extend(errors_search)
    for result in search_results:
        search_results_hashes = [ioc.get('value') for ioc in result.get('resources', [])]
        new_hashes = [h for h in hashes if h not in search_results_hashes]
        for h in new_hashes:
            results, errors = execute_command('cs-falcon-upload-custom-ioc',
                                              {'ioc_type': 'sha256',
                                               'platforms': 'linux,mac,windows',
                                               'applied_globally': 'true',
                                               'value': h,
                                               **ioc_metadata}, extract_contents=False)
            falcon_errors.extend(errors)
            falcon_results.extend(results)
        for ioc in result.get('resources', []):
            results, errors = execute_command('cs-falcon-update-custom-ioc',
                                              {'ioc_id': ioc.get('id'),
                                               **ioc_metadata}, extract_contents=False)
            falcon_errors.extend(errors)
            falcon_results.extend(results)

    return falcon_results, falcon_errors


def run_hash_action(hashes: List[str], action: str) -> list:
    """Returns a simple python dict with the information provided
    in the input (dummy).

    :type hashes: ``List[str]``
    :param hashes: string to add in the dummy dict that is returned

    :return: dict as {"dummy": dummy}
    :rtype: ``str``
    """

    # check instances
    full_results, full_errors = [], []
    instances_results, instance_errors = execute_command('GetInstances', {'brand': ','.join(INSTANCE_TO_FUNC.keys())})
    if instance_errors:
        raise DemistoException(f'Cant get instances because of {str(instance_errors)}')
    instances = {instance.get('brand') for instance in instances_results[0]}
    for instance in instances:
        # for each brand that configured, run the appropriate function
        results, errors = INSTANCE_TO_FUNC.get(instance)(hashes, action)
        full_results.extend(results)
        full_errors.extend(errors)
    # deal with errors
    if full_errors:
        error_msg = '\n'.join(['The following errors were encountered:'] + full_errors)
        if full_results:
            full_results.append(error_msg)
        else:
            raise DemistoException(error_msg)
    return full_results


''' MAIN FUNCTION '''


def main():
    hashes = argToList(demisto.args().get('hash', None))
    action = demisto.args().get('action')
    if not hashes:
        raise ValueError('hash not specified')
    if not action or action not in {'allow', 'block'}:
        raise ValueError('Action not specified or not in allowed actions')
    try:
        return_results(run_hash_action(hashes, action))
    except Exception as ex:
        demisto.error(traceback.format_exc())  # print the traceback
        return_error(f'Failed to execute HashWrapper. Error: {str(ex)}')


INSTANCE_TO_FUNC = {'Cortex XDR - IR': run_xdr_action,
                    'Microsoft Defender Advanced Threat Protection': run_msde_action,
                    'CrowdstrikeFalcon': run_crowdstrike_falcon_action}

''' ENTRY POINT '''

if __name__ in ('__main__', '__builtin__', 'builtins'):
    main()
