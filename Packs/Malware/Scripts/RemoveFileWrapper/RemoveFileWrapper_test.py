"""Base Script for Cortex XSOAR - Unit Tests file

Pytest Unit Tests: all funcion names must start with "test_"

More details: https://xsoar.pan.dev/docs/integrations/unit-testing

MAKE SURE YOU REVIEW/REPLACE ALL THE COMMENTS MARKED AS "TODO"

"""


import CommonServerPython
import RemoveFileWrapper

test_data = [CommonServerPython.ResultWrapper(command='endpoint',
                                              args={
                                                  'id': 'device1,device2',
                                                  'using-brand': 'CrowdstrikeFalcon'}, brand='CrowdstrikeFalcon',
                                              instance='CrowdstrikeFalcon_instance_1', result={'errors': [],
                                                                                               'meta': {
                                                                                                   'powered_by': 'device-api',
                                                                                                   'query_time': 0.004973417,
                                                                                                   'trace_id': 'f427204b-7fda-46d8-bbdd-e1185d48c9b1'},
                                                                                               'resources': [{
                                                                                                   'agent_load_flags': '0',
                                                                                                   'agent_local_time': '2022-01-20T23:53:01.669Z',
                                                                                                   'agent_version': '6.33.14705.0',
                                                                                                   'bios_manufacturer': 'Google',
                                                                                                   'bios_version': 'Google',
                                                                                                   'build_number': '17763',
                                                                                                   'cid': '20879a8064904ecfbb62c118a6a19411',
                                                                                                   'config_id_base': '65994753',
                                                                                                   'config_id_build': '14705',
                                                                                                   'config_id_platform': '3',
                                                                                                   'cpu_signature': '198384',
                                                                                                   'device_id': 'device1',
                                                                                                   'device_policies': {
                                                                                                       'device_control': {
                                                                                                           'applied': True,
                                                                                                           'applied_date': '2022-02-09T02:58:39.031881675Z',
                                                                                                           'assigned_date': '2022-02-09T02:53:05.094324126Z',
                                                                                                           'policy_id': '2eb87e60c3604b769c4fbfac20321011',
                                                                                                           'policy_type': 'device-control'},
                                                                                                       'firewall': {
                                                                                                           'applied': True,
                                                                                                           'applied_date': '2022-01-07T09:14:54.173196231Z',
                                                                                                           'assigned_date': '2022-01-07T09:10:07.361197933Z',
                                                                                                           'policy_id': 'ce93c24ff59143259c55ba090680091d',
                                                                                                           'policy_type': 'firewall',
                                                                                                           'rule_set_id': 'ce93c24ff59143259c55ba090680091d'},
                                                                                                       'global_config': {
                                                                                                           'applied': True,
                                                                                                           'applied_date': '2022-02-16T23:49:37.96895344Z',
                                                                                                           'assigned_date': '2022-02-16T23:46:52.920564399Z',
                                                                                                           'policy_id': 'e37c8333d2a24a02b787eba7d6015880',
                                                                                                           'policy_type': 'globalconfig',
                                                                                                           'settings_hash': 'e8d7e1cf'},
                                                                                                       'prevention': {
                                                                                                           'applied': True,
                                                                                                           'applied_date': '2021-12-02T07:48:15.225063184Z',
                                                                                                           'assigned_date': '2021-12-02T07:46:02.819116443Z',
                                                                                                           'policy_id': '599b3a36b08c4dd4ba2668ccf15f4ed9',
                                                                                                           'policy_type': 'prevention',
                                                                                                           'rule_groups': [
                                                                                                               '834ec379b09248cb857a13fd5d647cf0'],
                                                                                                           'settings_hash': 'eb3f349c'},
                                                                                                       'remote_response': {
                                                                                                           'applied': True,
                                                                                                           'applied_date': '2020-11-14T20:39:37.923730468Z',
                                                                                                           'assigned_date': '2020-11-14T20:38:27.150769027Z',
                                                                                                           'policy_id': 'f825fe39c38444d6aaef4a506a6b30ad',
                                                                                                           'policy_type': 'remote-response',
                                                                                                           'settings_hash': '5aa2f5b'},
                                                                                                       'sensor_update': {
                                                                                                           'applied': True,
                                                                                                           'applied_date': '2022-01-20T23:54:51.650270062Z',
                                                                                                           'assigned_date': '2022-01-20T23:50:41.872510982Z',
                                                                                                           'policy_id': 'd3af78bb65be44abb97484a4a6dde15d',
                                                                                                           'policy_type': 'sensor-update',
                                                                                                           'settings_hash': 'tagged|1;101',
                                                                                                           'uninstall_protection': 'ENABLED'}},
                                                                                                   'external_ip': '35.224.136.145',
                                                                                                   'first_seen': '2020-02-10T12:40:18Z',
                                                                                                   'group_hash': 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855',
                                                                                                   'groups': [],
                                                                                                   'hostname': 'FALCON-CROWDSTR',
                                                                                                   'instance_id': '5278723767695872635',
                                                                                                   'kernel_version': '10.0.17763.1518',
                                                                                                   'last_seen': '2022-03-07T12:12:11Z',
                                                                                                   'local_ip': '10.128.0.7',
                                                                                                   'mac_address': '42-01-0a-80-00-07',
                                                                                                   'major_version': '10',
                                                                                                   'meta': {
                                                                                                       'version': '61675'},
                                                                                                   'minor_version': '0',
                                                                                                   'modified_timestamp': '2022-03-07T12:12:21Z',
                                                                                                   'os_build': '17763',
                                                                                                   'os_version': 'Windows Server 2019',
                                                                                                   'platform_id': '0',
                                                                                                   'platform_name': 'Windows',
                                                                                                   'pointer_size': '8',
                                                                                                   'policies': [
                                                                                                       {
                                                                                                           'applied': True,
                                                                                                           'applied_date': '2021-12-02T07:48:15.225063184Z',
                                                                                                           'assigned_date': '2021-12-02T07:46:02.819116443Z',
                                                                                                           'policy_id': '599b3a36b08c4dd4ba2668ccf15f4ed9',
                                                                                                           'policy_type': 'prevention',
                                                                                                           'rule_groups': [
                                                                                                               '834ec379b09248cb857a13fd5d647cf0'],
                                                                                                           'settings_hash': 'eb3f349c'}],
                                                                                                   'product_type': '3',
                                                                                                   'product_type_desc': 'Server',
                                                                                                   'provision_status': 'Provisioned',
                                                                                                   'reduced_functionality_mode': 'no',
                                                                                                   'serial_number': 'GoogleCloud-2B07BF97E8ED43183F868AFBA20C6C3D',
                                                                                                   'service_pack_major': '0',
                                                                                                   'service_pack_minor': '0',
                                                                                                   'service_provider': 'GCP',
                                                                                                   'service_provider_account_id': '564609343865',
                                                                                                   'slow_changing_modified_timestamp': '2022-03-07T11:58:52Z',
                                                                                                   'status': 'normal',
                                                                                                   'system_manufacturer': 'Google',
                                                                                                   'system_product_name': 'Google Compute Engine',
                                                                                                   'tags': [],
                                                                                                   'zone_group': 'projects/564609343865/zones/us-central1-a'},
                                                                                                   {
                                                                                                       'agent_load_flags': '0',
                                                                                                       'agent_local_time': '2022-03-02T23:22:50.615Z',
                                                                                                       'agent_version': '6.34.13109.0',
                                                                                                       'bios_manufacturer': 'Google',
                                                                                                       'bios_version': 'Google',
                                                                                                       'cid': '20879a8064904ecfbb62c118a6a19411',
                                                                                                       'config_id_base': '65994753',
                                                                                                       'config_id_build': '13109',
                                                                                                       'config_id_platform': '8',
                                                                                                       'cpu_signature': '198384',
                                                                                                       'device_id': 'device2',
                                                                                                       'device_policies': {
                                                                                                           'global_config': {
                                                                                                               'applied': True,
                                                                                                               'applied_date': '2022-03-02T23:24:10.845078322Z',
                                                                                                               'assigned_date': '2022-03-02T23:22:51.47362329Z',
                                                                                                               'policy_id': 'b0ed04f7097f48c8875df57c58c4c5b6',
                                                                                                               'policy_type': 'globalconfig',
                                                                                                               'settings_hash': '9673618e'},
                                                                                                           'prevention': {
                                                                                                               'applied': True,
                                                                                                               'applied_date': '2021-08-08T11:34:53.617741661Z',
                                                                                                               'assigned_date': '2021-08-08T11:34:32.474354135Z',
                                                                                                               'policy_id': '2a47e83404424e4fa4204160efcaab5e',
                                                                                                               'policy_type': 'prevention',
                                                                                                               'rule_groups': [],
                                                                                                               'settings_hash': 'd4cbb29'},
                                                                                                           'remote_response': {
                                                                                                               'applied': True,
                                                                                                               'applied_date': '2022-01-24T18:19:59.179150622Z',
                                                                                                               'assigned_date': '2022-01-24T18:18:49.331622153Z',
                                                                                                               'policy_id': '255d4887829941268c9f2e5e6877657e',
                                                                                                               'policy_type': 'remote-response',
                                                                                                               'settings_hash': '9b309c52'},
                                                                                                           'sensor_update': {
                                                                                                               'applied': True,
                                                                                                               'applied_date': '2022-03-02T23:24:10.840990369Z',
                                                                                                               'assigned_date': '2022-03-02T23:21:35.797173451Z',
                                                                                                               'policy_id': 'c87b0bd84441408e967c7190d083b34e',
                                                                                                               'policy_type': 'sensor-update',
                                                                                                               'settings_hash': 'tagged|5;',
                                                                                                               'uninstall_protection': 'UNKNOWN'}},
                                                                                                       'external_ip': '35.224.136.145',
                                                                                                       'first_seen': '2021-08-08T11:33:21Z',
                                                                                                       'group_hash': 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855',
                                                                                                       'groups': [],
                                                                                                       'hostname': 'falcon-crowdstrike-sensor-centos7',
                                                                                                       'instance_id': '7439962612154109441',
                                                                                                       'kernel_version': '3.10.0-1160.31.1.el7.x86_64',
                                                                                                       'last_seen': '2022-03-07T12:29:29Z',
                                                                                                       'local_ip': '10.128.0.19',
                                                                                                       'mac_address': '42-01-0a-80-00-13',
                                                                                                       'major_version': '3',
                                                                                                       'meta': {
                                                                                                           'version': '16992'},
                                                                                                       'minor_version': '10',
                                                                                                       'modified_timestamp': '2022-03-07T12:31:15Z',
                                                                                                       'os_version': 'CentOS 7.9',
                                                                                                       'platform_id': '3',
                                                                                                       'platform_name': 'Linux',
                                                                                                       'policies': [
                                                                                                           {
                                                                                                               'applied': True,
                                                                                                               'applied_date': '2021-08-08T11:34:53.617741661Z',
                                                                                                               'assigned_date': '2021-08-08T11:34:32.474354135Z',
                                                                                                               'policy_id': '2a47e83404424e4fa4204160efcaab5e',
                                                                                                               'policy_type': 'prevention',
                                                                                                               'rule_groups': [],
                                                                                                               'settings_hash': 'd4cbb29'}],
                                                                                                       'product_type_desc': 'Server',
                                                                                                       'provision_status': 'NotProvisioned',
                                                                                                       'reduced_functionality_mode': 'no',
                                                                                                       'serial_number': 'GoogleCloud-A08065CD718B9821F8CDA1989A8D65AE',
                                                                                                       'service_provider': 'GCP',
                                                                                                       'service_provider_account_id': '564609343865',
                                                                                                       'slow_changing_modified_timestamp': '2022-03-07T12:23:44Z',
                                                                                                       'status': 'normal',
                                                                                                       'system_manufacturer': 'Google',
                                                                                                       'system_product_name': 'Google Compute Engine',
                                                                                                       'tags': [],
                                                                                                       'zone_group': 'projects/564609343865/zones/us-central1-a'}]})]


def test_get_crowdstrike_os_to_id(mocker):
    """
    Given:
        A list of devices ids which are on crowdstrike
    When:
        Getting the os for each device
    Then:
        Return a mapping between an OS and a set of device-ids what are on the OS.

    """
    from RemoveFileWrapper import get_crowdstrike_os_to_id
    mocker.patch.object(RemoveFileWrapper, 'execute_commands_multiple_results',
                        return_value=(test_data, []))
    os_to_id = get_crowdstrike_os_to_id(['device2', 'device1'])
    assert os_to_id == {'Windows': {'device1'}, 'Linux': {'device2'}}


def test_create_command_wrappers(mocker):
    """
    Given:
        the action to perform (allow or block)
    When:
        Calling `create_command_wrappers` to get all the command wrappers for the script.
    Then:
        Ensure the right commands wrappers are being returned.

    """
    from RemoveFileWrapper import demisto, create_commands_wrapper
    device_ids = ['device1',
                  'device2',
                  'device3',
                  'device4']
    file_path = 'filepath'
    mocker.patch.object(demisto, 'incident', return_value={'id': 1})
    mocker.patch.object(RemoveFileWrapper, 'get_crowdstrike_os_to_id', return_value={'Windows': {'device1', 'device2'},
                                                                                     'Linux': {'device3'},
                                                                                     'Mac': {'device4'}})
    command_wrappers = create_commands_wrapper(device_ids, file_path)
    assert len(command_wrappers) == 2
    assert {command_wrapper.brand for command_wrapper in command_wrappers} == \
           {'Cortex XDR - IR', 'CrowdstrikeFalcon'}
    for command_wrapper in command_wrappers:
        if command_wrapper.brand == 'Cortex XDR - IR':
            assert isinstance(command_wrapper.commands, str)
            assert isinstance(command_wrapper.args_lst, dict)
            assert command_wrapper.commands == 'xdr-run-script-delete-file'
            assert command_wrapper.args_lst == {'endpoint_ids': ','.join(device_ids),
                                                'file_path': file_path}
        if command_wrapper.brand == 'CrowdstrikeFalcon':
            assert isinstance(command_wrapper.commands, list)
            assert isinstance(command_wrapper.args_lst, list)
            assert len(command_wrapper.commands) == 3  # al OSes
            assert len(command_wrapper.args_lst) == 3  # al OSes
            assert set(command_wrapper.commands) == {'cs-falcon-rtr-remove-file'}
            assert command_wrapper.args_lst[0].get('host_ids') in {'device1,device2', 'device2,device1'}
            assert command_wrapper.args_lst[1:] == [
                                                {'host_ids': 'device3',
                                                 'file_path': file_path,
                                                 'os': 'Linux'},
                                                {'host_ids': 'device4',
                                                 'file_path': file_path,
                                                 'os': 'Mac'}
                                                ]
