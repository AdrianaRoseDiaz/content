"""Base Script for Cortex XSOAR - Unit Tests file

Pytest Unit Tests: all funcion names must start with "test_"

More details: https://xsoar.pan.dev/docs/integrations/unit-testing
"""

import pytest


@pytest.mark.parametrize('action', ['isolate', 'unisolate'])
def test_create_command_executers(mocker, action):
    """
    Given:
        the action to perform (allow or block)
    When:
        Calling `create_command_wrappers` to get all the command wrappers for the script.
    Then:
        Ensure the right commands wrappers are being returned.

    """
    from IsolationAssetWrapper import demisto, create_commands, MSDE_ACTIONS, XDR_ACTIONS, \
        CROWDSTRIKE_ACTIONS
    device_ids = ['device1',
                  'device2',
                  'device3']
    mocker.patch.object(demisto, 'incident', return_value={'id': 1})
    msde_command, msde_args = MSDE_ACTIONS[action]
    msde_args.update({'using-brand': 'Microsoft Defender Advanced Threat Protection'})
    command_executers = create_commands(device_ids, action)
    assert len(command_executers) == 3
    brands = set()
    for command_executer in command_executers:
        for args in command_executer.args_lst:
            brands.add(args.get('using-brand'))

    assert brands == {'Cortex XDR - IR', 'CrowdstrikeFalcon', 'Microsoft Defender Advanced Threat Protection'}
    for command_executer in command_executers:
        brand = command_executer.args_lst[0].get('using-brand')
        if brand == 'Microsoft Defender Advanced Threat Protection':
            assert command_executer.commands == [msde_command]
            assert command_executer.args_lst == [msde_args]
        if brand == 'Cortex XDR - IR':
            assert len(command_executer.commands) == len(device_ids)
            assert len(command_executer.args_lst) == len(device_ids)
            assert set(command_executer.commands) == {XDR_ACTIONS.get(action)}
            assert command_executer.args_lst == [{'endpoint_id': device_id} for device_id in device_ids]
        if brand == 'CrowdstrikeFalcon':
            assert command_executer.commands == [CROWDSTRIKE_ACTIONS.get(action)]
            assert command_executer.args_lst == [{'ids': ','.join(device_ids)}]
